<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SDHGCTF | 荣誉大屏</title>

    <!-- ✅ CDN 加速：bootcdn/cdnjs 换成 jsDelivr -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">

    <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #020612;
            --panel: #0a162e;
            --accent: #00d4ff;
            --gold: #ffd700;
        }
        body {
            background: var(--bg);
            color: white;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            padding: 20px;
            padding-top: 80px;
            overflow-x: hidden;
        }

        .contest-main-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 10px;
            background: linear-gradient(to right, #00d4ff, #fff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
            white-space: nowrap;
        }

        .trend-box {
            background: rgba(10, 22, 46, 0.6);
            border: 1px solid #1a3a5a;
            border-radius: 8px;
            padding: 20px;
            height: 380px;
            margin-bottom: 40px;
            box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1);
        }

        .pro-table-container {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #1a3a5a;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .pro-table {
            margin-bottom: 0;
            background: #050b1a;
            border-collapse: separate;
            border-spacing: 0;
        }

        .pro-table thead tr {
            background: linear-gradient(to right, #0055ff, #00d4ff);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .pro-table th {
            border: none !important;
            padding: 18px 10px !important;
            text-align: center;
            color: white;
            font-size: 0.85rem;
        }

        .pro-table tbody tr {
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid #1a3a5a;
            transition: 0.2s;
        }
        .pro-table tbody tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }
        .pro-table td {
            padding: 16px 10px !important;
            vertical-align: middle;
            text-align: center;
            border: none;
            font-size: 0.95rem;
        }

        .pro-table tbody tr.rank-1 {
            background: linear-gradient(to right, #ffcc00, #ffeb3b) !important;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.4);
        }
        .pro-table tbody tr.rank-1 td {
            color: #fff !important;
            font-weight: 800;
        }
        .pro-table tbody tr.rank-1 .badge {
            background: rgba(244, 177, 79, 0.8) !important;
            color: #fff !important;
        }
        .pro-table tbody tr.rank-1 .score-text {
             color: #fff !important;
        }
        .pro-table tbody tr.rank-1 .fa-fire {
            color: #d90429 !important;
        }

        .score-text {
            color: var(--accent);
            font-weight: bold;
            font-family: 'Consolas', monospace;
        }
        .medal-icon {
            font-size: 1.2rem;
        }
        .badge-cat {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 4px 10px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark fixed-top" style="background: rgba(5, 11, 26, 0.8); backdrop-filter: blur(10px);">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-arrow-left me-2"></i> 返回主菜单
            </a>

            <span class="navbar-text fw-bold" style="font-size: 1.2rem; color: #00d4ff; text-shadow: 0 0 10px #00d4ff;">
                实时荣誉大屏
            </span>

            <div class="d-flex align-items-center">
                <a href="matrix.html" class="btn btn-outline-info btn-sm me-3">
                    <i class="fas fa-th me-1"></i> 切换至解题位图
                </a>
                <span id="current-time" class="navbar-text" style="font-family: monospace;"></span>
            </div>
        </div>
    </nav>

    <div class="contest-main-title">SDHGCTF 2026 期末巅峰挑战赛</div>

    <div class="container-fluid">
        <div class="trend-box">
            <canvas id="trendChart"></canvas>
        </div>

        <div class="pro-table-container">
            <table class="table table-dark pro-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">排名</th>
                        <th class="text-start" style="padding-left: 30px !important;">战队 / 选手名称</th>
                        <th>总分积分</th>
                        <th>擅长领域</th>
                        <th>解题总数</th>
                        <th>一血荣誉</th>
                        <th>最后活跃时间</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ✅ 跟 index/admin 一致：自动识别端口，避免 PyCharm 63342 打开时跨端口问题
        const API_PORT = 5000;
        const API_HOST = (location.port === String(API_PORT))
          ? `${location.protocol}//${location.host}`
          : `${location.protocol}//${location.hostname}:${API_PORT}`;
        const API_BASE = `${API_HOST}/api`;

        let trendChart = null;

        function getToken(){
          return localStorage.getItem('ctf_token') || '';
        }

        // ✅ apiFetch（你原来就有）
        async function apiFetch(url, options = {}){
          const target = url.startsWith('http') ? url : `${API_BASE}${url}`;
          const method = (options.method || 'GET').toUpperCase();
          const headers = Object.assign({}, (options.headers || {}));

          // GET 不加 Content-Type，避免预检
          if(!headers['Content-Type'] && method !== 'GET' && method !== 'HEAD'){
            headers['Content-Type'] = 'application/json';
          }

          const token = getToken();
          if(token){
            headers['Authorization'] = `Bearer ${token}`;
          }

          return fetch(target, Object.assign({}, options, { headers }));
        }

        function unwrap(json){
          return (json && json.data !== undefined) ? json.data : json;
        }

        async function updateData() {
            try {
                const res = await apiFetch('/scoreboard_pro');
                const raw = await res.json().catch(()=> ({}));
                const data = unwrap(raw);

                if (!data || !data.users || !data.trends) {
                    console.error("从API获取的数据格式不正确:", raw);
                    return;
                }

                const body = document.getElementById('leaderboard-body');
                body.innerHTML = data.users.map(u => {
                    let rankIcon = u.rank;
                    if(u.rank === 1) rankIcon = '<i class="fas fa-medal medal-icon" style="color:#FFB040"></i>';
                    else if(u.rank === 2) rankIcon = '<i class="fas fa-medal medal-icon" style="color:#AEAAA7"></i>';
                    else if(u.rank === 3) rankIcon = '<i class="fas fa-medal medal-icon" style="color:#A46628"></i>';

                    return `
                        <tr class="${u.rank === 1 ? 'rank-1' : ''}">
                            <td>${rankIcon}</td>
                            <td class="text-start" style="padding-left: 30px !important;">
                                <i class="fas fa-user-ninja me-2 opacity-75"></i> ${u.username}
                            </td>
                            <td class="score-text">${u.score}</td>
                            <td><span class="badge badge-cat">${u.strongest_cat || '-'}</span></td>
                            <td>${u.solve_count ?? 0}</td>
                            <td><i class="fas fa-fire text-danger me-1"></i>${u.first_bloods ?? 0}</td>
                            <td class="small opacity-75">${u.last_update || '-'}</td>
                        </tr>
                    `;
                }).join('');

                // ✅ 使用后端返回的时间轴
                renderChart(data.trends, data.users, data.trend_labels);
            } catch (e) {
                console.error("数据加载失败:", e);
            }
        }

        function normalizePoints(points, targetLen){
            const arr = Array.isArray(points) ? points.slice() : [];
            if(arr.length === 0){
                return Array(targetLen).fill(0);
            }
            if(arr.length < targetLen){
                const last = arr[arr.length - 1];
                while(arr.length < targetLen) arr.push(last);
                return arr;
            }
            if(arr.length > targetLen){
                return arr.slice(arr.length - targetLen);
            }
            return arr;
        }

        function renderChart(trends, users, labelsFromApi) {
            const canvas = document.getElementById('trendChart');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');

            const labels = (Array.isArray(labelsFromApi) && labelsFromApi.length > 0)
              ? labelsFromApi
              : ['Start', 'Phase 1', 'Phase 2', 'Phase 3', 'Now'];

            const colors = ['#00d4ff', '#ffcc00', '#ff4d4d', '#a855f7', '#10b981', '#f472b6', '#ffffff', '#34d399', '#fbbf24'];

            const topUsers = users.slice(0, 15);
            const topUsernames = topUsers.map(u => u.username);

            const datasets = Object.entries(trends)
                .filter(([name]) => topUsernames.includes(name))
                .map(([name, points]) => {
                    const user = users.find(u => u.username === name);
                    const colorIndex = topUsernames.indexOf(name);

                    const fixedPoints = normalizePoints(points, labels.length);

                    return {
                        label: `#${user ? user.rank : '?'} ${name}`,
                        data: fixedPoints,
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length],
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        fill: false
                    };
                });

            if(trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800 },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#8899a6',
                                font: { size: 12, weight: 'bold' },
                                padding: 20,
                                usePointStyle: true,
                                boxWidth: 8
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(10, 22, 46, 0.8)',
                            titleFont: { size: 14, weight: 'bold'},
                            bodyFont: { size: 12 },
                            padding: 10,
                            cornerRadius: 4
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#8899a6', maxRotation: 0, autoSkip: true, maxTicksLimit: 12 }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.08)' },
                            ticks: { color: '#8899a6' }
                        }
                    }
                }
            });
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
            const timeEl = document.getElementById('current-time');
            if (timeEl) timeEl.innerText = timeString;
        }

        // 初始加载 + 定时刷新
        window.addEventListener('DOMContentLoaded', ()=>{
          updateData();
          updateTime();
          setInterval(updateData, 60000); // ✅ 每60秒刷新一次数据
          setInterval(updateTime, 1000);
        });
    </script>
</body>
</html>
