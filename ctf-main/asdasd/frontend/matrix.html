<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SDHGCTF | 全场解题位图</title>
  
  <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <style>
    :root {
      --bg-primary: #050b1a;
      --bg-secondary: #081a2f;
      --bg-tertiary: #0a1f3a;
      --glass-light: rgba(255, 255, 255, 0.09);
      --glass-medium: rgba(255, 255, 255, 0.06);
      --glass-dark: rgba(255, 255, 255, 0.03);
      --border-light: rgba(255, 255, 255, 0.18);
      --border-medium: rgba(255, 255, 255, 0.12);
      --border-dark: rgba(255, 255, 255, 0.08);
      --accent-cyan: #00d4ff;
      --accent-purple: #7c4dff;
      --text-primary: #e9f2ff;
      --text-secondary: rgba(233, 242, 255, 0.75);
      --text-muted: rgba(233, 242, 255, 0.55);
      --shadow-lg: 0 20px 70px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 12px 40px rgba(0, 0, 0, 0.35);
      --shadow-sm: 0 8px 25px rgba(0, 0, 0, 0.22);
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      min-height: 100vh;
      height: 100vh;
      overflow: hidden;
      background: 
        radial-gradient(900px 500px at 15% 20%, rgba(0, 212, 255, 0.18), transparent 60%),
        radial-gradient(700px 500px at 85% 30%, rgba(124, 77, 255, 0.18), transparent 60%),
        radial-gradient(800px 600px at 40% 90%, rgba(255, 77, 109, 0.12), transparent 60%),
        linear-gradient(180deg, var(--bg-primary), var(--bg-secondary) 60%, var(--bg-tertiary));
      color: var(--text-primary);
      font-family: 'Segoe UI', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 0;
      padding-top: 70px;
      position: relative;
      line-height: 1.6;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      opacity: 0.09;
      pointer-events: none;
      mix-blend-mode: overlay;
      z-index: 2;
    }
    
    .aurora-layer {
      position: fixed;
      inset: -22vh -22vw;
      pointer-events: none;
      z-index: 1;
      opacity: 0.55;
      filter: blur(46px) saturate(160%);
      mix-blend-mode: screen;
      background:
        radial-gradient(60% 50% at 20% 30%, rgba(0,212,255,.32), transparent 60%),
        radial-gradient(55% 45% at 78% 28%, rgba(124,77,255,.30), transparent 62%),
        radial-gradient(50% 40% at 35% 78%, rgba(0,212,255,.22), transparent 62%),
        radial-gradient(48% 40% at 85% 80%, rgba(124,77,255,.20), transparent 62%);
      animation: auroraFloat 14s ease-in-out infinite alternate;
      will-change: transform;
    }
    
    .aurora-layer.layer2 {
      opacity: 0.42;
      filter: blur(62px) saturate(170%);
      animation-duration: 18s;
      background:
        radial-gradient(52% 45% at 30% 25%, rgba(124,77,255,.24), transparent 62%),
        radial-gradient(58% 48% at 70% 40%, rgba(0,212,255,.20), transparent 62%),
        radial-gradient(55% 45% at 45% 85%, rgba(124,77,255,.18), transparent 62%);
    }
    
    @keyframes auroraFloat {
      0%   { transform: translate3d(-3%, -2%, 0) scale(1.02) rotate(-1deg); }
      50%  { transform: translate3d(2%, 3%, 0) scale(1.05) rotate(1deg); }
      100% { transform: translate3d(-1%, 2%, 0) scale(1.03) rotate(-0.6deg); }
    }
    
    #fx-canvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
    }
    
    .page-wrap {
      position: relative;
      z-index: 5;
      width: 100%;
      height: calc(100vh - 70px);
      display: flex;
      flex-direction: column;
      padding: 0 15px 15px 15px;
    }
    
    .nav-glass {
      background: rgba(5, 11, 26, 0.75) !important;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border-medium);
      box-shadow: var(--shadow-md);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      z-index: 1000;
    }
    
    .nav-glass::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -1px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(0,212,255,.4) 20%, rgba(124,77,255,.4) 50%, rgba(0,212,255,.4) 80%, transparent);
      opacity: 0.6;
    }
    
    .navbar-brand {
      font-weight: 600;
      transition: all var(--transition-fast);
    }
    
    .navbar-brand:hover {
      color: var(--accent-cyan) !important;
      transform: translateX(-3px);
    }
    
    .btn-outline-light {
      border-color: var(--border-light);
      backdrop-filter: blur(10px);
      transition: all var(--transition-fast);
    }
    
    .btn-outline-light:hover {
      background: var(--glass-light);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan) !important;
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .header-area {
      text-align: center;
      margin-bottom: 15px;
      user-select: none;
      flex-shrink: 0;
    }
    
    .header-area p {
      margin-bottom: 4px;
      letter-spacing: 3px;
      font-size: 0.7rem;
      color: var(--accent-cyan);
      opacity: 0.85;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .header-area h2 {
      font-weight: 900;
      letter-spacing: 10px;
      margin: 0;
      font-size: 1.8rem;
      background: linear-gradient(90deg, var(--accent-cyan) 0%, #fff 25%, var(--accent-purple) 50%, #fff 75%, var(--accent-cyan) 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 8s ease infinite;
      filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.15));
    }
    
    @keyframes gradientShift {
      0%, 100% { background-position: 0% center; }
      50% { background-position: 100% center; }
    }
    
    .header-sub {
      margin-top: 6px;
      color: var(--text-secondary);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .legend {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      font-size: 0.75rem;
    }
    
    .legend span {
      background: var(--glass-medium);
      border: 1px solid var(--border-medium);
      padding: 5px 10px;
      border-radius: 50px;
      backdrop-filter: blur(15px);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .legend span:hover {
      background: var(--glass-light);
      border-color: var(--border-light);
      transform: translateY(-2px);
    }
    
    .matrix-container {
      border-radius: 20px;
      overflow: hidden;
      background: var(--glass-medium);
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(25px) saturate(180%);
      -webkit-backdrop-filter: blur(25px) saturate(180%);
      position: relative;
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .matrix-container::before {
      content: "";
      position: absolute;
      inset: -1px;
      pointer-events: none;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(0,212,255,.25), rgba(124,77,255,.20) 50%, transparent);
      opacity: 0.4;
      padding: 1px;
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
    }
    
    .matrix-table-wrapper {
      flex: 1;
      overflow: auto;
      scrollbar-color: rgba(0, 212, 255, 0.4) var(--glass-medium);
      scrollbar-width: thin;
    }
    
    .matrix-table-wrapper::-webkit-scrollbar { width: 10px; height: 10px; }
    .matrix-table-wrapper::-webkit-scrollbar-track {
      background: var(--glass-medium);
      border-radius: 50px;
      border: 1px solid var(--border-dark);
    }
    .matrix-table-wrapper::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, rgba(0,212,255,.6), rgba(124,77,255,.6));
      border-radius: 50px;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .matrix-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      background: rgba(5, 11, 26, 0.4);
    }
    
    .matrix-table thead tr {
      background: transparent;
    }
    
    .matrix-table th {
      border: 1px solid var(--border-medium);
      padding: 12px 8px;
      text-align: center;
      vertical-align: bottom;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-secondary);
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(5, 11, 26, 0.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .matrix-table th::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -1px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(0,212,255,.3) 25%, rgba(124,77,255,.3) 50%, rgba(0,212,255,.3) 75%, transparent);
      opacity: 0.8;
    }
    
    .v-text {
      writing-mode: vertical-lr;
      max-height: 100px;
      display: inline-block;
      margin-bottom: 8px;
      letter-spacing: 1.5px;
      font-weight: 600;
    }
    
    .matrix-table td {
      border: 1px solid var(--border-dark);
      text-align: center;
      vertical-align: middle;
      height: 48px;
      padding: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background: rgba(255, 255, 255, 0.015);
      transition: all var(--transition-fast);
    }
    
    .matrix-table tbody tr:nth-child(even) td {
      background: rgba(255, 255, 255, 0.025);
    }
    
    .matrix-table tbody tr:hover td {
      background: rgba(0, 212, 255, 0.08);
      box-shadow: inset 0 0 0 1px rgba(0, 212, 255, 0.2);
    }
    
    .rank-col { width: 80px; min-width: 80px; }
    .name-col {
      width: 180px;
      min-width: 150px;
      text-align: left !important;
      padding-left: 18px !important;
      font-weight: 700;
      color: var(--text-primary);
    }
    .score-col {
      width: 100px;
      min-width: 90px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-weight: 800;
      font-size: 1.05rem;
      color: var(--accent-cyan);
      text-shadow: 0 0 12px rgba(0, 212, 255, 0.2);
    }
    .solves-col {
      width: 90px;
      min-width: 80px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-weight: 600;
    }
    .chal-col { width: 50px; min-width: 45px; }
    
    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--glass-medium);
      border: 1.5px solid var(--border-light);
      color: var(--text-secondary);
      padding: 6px 11px;
      border-radius: 50px;
      font-weight: 700;
      font-size: 0.9rem;
      box-shadow: var(--shadow-sm);
      min-width: 45px;
    }
    
    .top1 .rank-badge {
      border-color: rgba(255, 204, 0, 0.5);
      background: linear-gradient(135deg, rgba(255, 204, 0, 0.15), rgba(255, 180, 0, 0.08));
      color: #ffd700;
      box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.12), var(--shadow-sm);
      font-size: 1rem;
      animation: pulseGold 2s ease-in-out infinite;
    }
    
    @keyframes pulseGold {
      0%, 100% { box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.12), var(--shadow-sm); }
      50% { box-shadow: 0 0 0 5px rgba(255, 204, 0, 0.18), 0 10px 30px rgba(255, 204, 0, 0.25); }
    }
    
    .top2 .rank-badge {
      border-color: rgba(229, 231, 235, 0.4);
      background: linear-gradient(135deg, rgba(229, 231, 235, 0.12), rgba(200, 200, 200, 0.06));
      color: #e5e7eb;
      box-shadow: 0 0 0 3px rgba(229, 231, 235, 0.10), var(--shadow-sm);
      animation: pulseSilver 2s ease-in-out infinite;
    }
    
    @keyframes pulseSilver {
      0%, 100% { box-shadow: 0 0 0 3px rgba(229, 231, 235, 0.10), var(--shadow-sm); }
      50% { box-shadow: 0 0 0 5px rgba(229, 231, 235, 0.15), 0 10px 30px rgba(229, 231, 235, 0.20); }
    }
    
    .top3 .rank-badge {
      border-color: rgba(205, 127, 50, 0.4);
      background: linear-gradient(135deg, rgba(205, 127, 50, 0.12), rgba(180, 100, 40, 0.06));
      color: #cd7f32;
      box-shadow: 0 0 0 3px rgba(205, 127, 50, 0.10), var(--shadow-sm);
      animation: pulseBronze 2s ease-in-out infinite;
    }
    
    @keyframes pulseBronze {
      0%, 100% { box-shadow: 0 0 0 3px rgba(205, 127, 50, 0.10), var(--shadow-sm); }
      50% { box-shadow: 0 0 0 5px rgba(205, 127, 50, 0.15), 0 10px 30px rgba(205, 127, 50, 0.20); }
    }
    
    .fa-award.gold {
      color: #ffcc00;
      font-size: 1.1rem;
      filter: drop-shadow(0 0 8px rgba(255, 204, 0, 0.4));
      animation: iconGlow 2s ease-in-out infinite;
    }
    
    .fa-award.silver {
      color: #e5e7eb;
      font-size: 1rem;
      filter: drop-shadow(0 0 7px rgba(229, 231, 235, 0.3));
      animation: iconGlow 2s ease-in-out infinite 0.2s;
    }
    
    .fa-award.bronze {
      color: #cd7f32;
      font-size: 0.9rem;
      filter: drop-shadow(0 0 6px rgba(205, 127, 50, 0.3));
      animation: iconGlow 2s ease-in-out infinite 0.4s;
    }
    
    @keyframes iconGlow {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.85; transform: scale(1.08); }
    }
    
    .fa-flag.solved {
      color: #38bdf8;
      filter: drop-shadow(0 0 6px rgba(56, 189, 248, 0.3));
    }
    
    .dot {
      color: #1a3a5a;
      font-size: 0.4rem;
      opacity: 0.6;
    }
    
    .refresh-tag {
      position: fixed;
      bottom: 18px;
      right: 20px;
      font-size: 0.78rem;
      color: var(--text-secondary);
      background: rgba(5, 11, 26, 0.75);
      border: 1px solid var(--border-medium);
      padding: 9px 14px;
      border-radius: 50px;
      backdrop-filter: blur(20px);
      z-index: 100;
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    @media (max-width: 768px) {
      body { padding-top: 65px; }
      .nav-glass { height: 65px; }
      .page-wrap { height: calc(100vh - 65px); padding: 0 10px 10px; }
      .header-area h2 { letter-spacing: 6px; font-size: 1.4rem; }
      .name-col { width: 140px; min-width: 120px; }
    }
    
    @media (max-width: 576px) {
      .header-area h2 { letter-spacing: 4px; font-size: 1.2rem; }
      .legend { gap: 6px; }
      .legend span { padding: 4px 8px; font-size: 0.7rem; }
    }
    
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
      }
      .aurora-layer { animation: none; }
      #fx-canvas { display: none; }
    }
  </style>
</head>

<body>
  <canvas id="fx-canvas"></canvas>
  <div class="aurora-layer"></div>
  <div class="aurora-layer layer2"></div>
  
  <div class="page-wrap">
    <nav class="navbar navbar-dark fixed-top nav-glass">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">
          <i class="fas fa-arrow-left me-2"></i> 返回主菜单
        </a>
        <span class="navbar-text fw-bold" style="font-size: 1.1rem; color: var(--accent-cyan);">全场解题位图</span>
        <div class="d-flex align-items-center">
          <a href="scoreboard.html" class="btn btn-outline-light btn-sm me-3">
            <i class="fas fa-trophy me-1"></i> 切换至荣誉榜
          </a>
          <span id="current-time" class="navbar-text" style="font-family: Monaco, Consolas, monospace; font-size: 0.85rem;"></span>
        </div>
      </div>
    </nav>
    
    <div class="header-area">
      <p>LIVE SOLVE MATRIX</p>
      <h2>解题位图控制台</h2>
      <div class="header-sub">
        <i class="fa-solid fa-bolt"></i>
        <span>实时同步</span>
      </div>
      
      <div class="legend">
        <span><i class="fas fa-award gold"></i>一血</span>
        <span><i class="fas fa-award silver"></i>二血</span>
        <span><i class="fas fa-award bronze"></i>三血</span>
        <span><i class="fas fa-flag solved"></i>已解</span>
        <span><i class="fas fa-circle dot"></i>未解</span>
      </div>
    </div>
    
    <div class="matrix-container">
      <div class="matrix-table-wrapper">
        <table class="matrix-table">
          <thead id="m-head"></thead>
          <tbody id="m-body"></tbody>
        </table>
      </div>
    </div>
    
    <div class="refresh-tag">
      <i class="fas fa-sync fa-spin"></i>
      <span>数据每 30 秒自动同步</span>
    </div>
  </div>
  
  <script>
    function updateTime() {
      const now = new Date();
      const timeEl = document.getElementById('current-time');
      if (timeEl) timeEl.innerText = now.toLocaleTimeString('zh-CN', { hour12: false });
    }
    setInterval(updateTime, 1000);
    updateTime();
    
    const API_PORT = 5000;
    const API_HOST = (location.port === String(API_PORT))
      ? `${location.protocol}//${location.host}`
      : `${location.protocol}//${location.hostname}:${API_PORT}`;
    const API_BASE = `${API_HOST}/api`;
    
    function getToken() { return localStorage.getItem('ctf_token') || ''; }
    
    async function apiFetch(url, options = {}) {
      const target = url.startsWith('http') ? url : (url.startsWith('/') ? `${API_BASE}${url}` : `${API_BASE}/${url}`);
      const method = (options.method || 'GET').toUpperCase();
      const headers = Object.assign({}, options.headers || {});
      if (!headers['Content-Type'] && method !== 'GET' && method !== 'HEAD') {
        headers['Content-Type'] = 'application/json';
      }
      const token = getToken();
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return fetch(target, Object.assign({}, options, { headers, cache: 'no-store' }));
    }
    
    function renderEmpty(msg) {
      document.getElementById('m-head').innerHTML = `
        <tr>
          <th class="rank-col">RANK</th>
          <th class="name-col text-start ps-3">CONTESTANT</th>
          <th class="score-col">SCORE</th>
          <th class="solves-col">SOLVES</th>
        </tr>
      `;
      document.getElementById('m-body').innerHTML = `
        <tr><td colspan="4" style="color: rgba(233,242,255,.55); text-align: center; padding: 40px;">${msg}</td></tr>
      `;
    }
    
    async function updateMatrix() {
      try {
        const res = await apiFetch('/scoreboard_pro');
        if (!res.ok) {
          renderEmpty(`❌ 加载失败: HTTP ${res.status}`);
          return;
        }
        
        const data = await res.json().catch(() => null);
        const payload = (data && data.data) ? data.data : data;
        
        if (!payload || !payload.users || !payload.challenges) {
          renderEmpty('⚠️ 数据为空');
          return;
        }
        
        let hHtml = `<tr><th class="rank-col">RANK</th><th class="name-col text-start ps-3">CONTESTANT</th><th class="score-col">SCORE</th><th class="solves-col">SOLVES</th>`;
        payload.challenges.forEach(c => {
          hHtml += `<th class="chal-col"><div class="v-text">${c.title}</div><div class="small opacity-75">${c.points}</div></th>`;
        });
        document.getElementById('m-head').innerHTML = hHtml + `</tr>`;
        
        document.getElementById('m-body').innerHTML = payload.users.map(u => {
          const topCls = u.rank === 1 ? 'top1' : u.rank === 2 ? 'top2' : u.rank === 3 ? 'top3' : '';
          let row = `<tr class="${topCls}">
            <td class="rank-col"><span class="rank-badge">${u.rank}</span></td>
            <td class="name-col"><i class="fas fa-user-circle me-2 opacity-50"></i>${u.username}</td>
            <td class="score-col">${u.score}</td>
            <td class="solves-col">${u.solve_count}</td>`;
          
          payload.challenges.forEach(c => {
            const s = (u.matrix && u.matrix[c.id]) ? u.matrix[c.id] : 0;
            let icon = '<i class="fas fa-circle dot"></i>';
            if (s === 1) icon = '<i class="fas fa-award gold"></i>';
            else if (s === 2) icon = '<i class="fas fa-award silver"></i>';
            else if (s === 3) icon = '<i class="fas fa-award bronze"></i>';
            else if (s === 4) icon = '<i class="fas fa-flag solved"></i>';
            row += `<td class="chal-col">${icon}</td>`;
          });
          return row + `</tr>`;
        }).join('');
      } catch (e) {
        console.error(e);
        renderEmpty('❌ 加载失败');
      }
    }
    
    renderEmpty('⏳ 加载中...');
    updateMatrix();
    setInterval(updateMatrix, 30000);
    
    // 粒子动画
    (function() {
      const canvas = document.getElementById('fx-canvas');
      if (!canvas || (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches)) return;
      
      const ctx = canvas.getContext('2d', { alpha: true });
      let w = 0, h = 0, dpr = 1;
      const isMobile = matchMedia('(max-width: 768px)').matches;
      const COUNT = isMobile ? 220 : 520;
      const LINE_MIN = isMobile ? 6 : 7;
      const LINE_MAX = isMobile ? 14 : 18;
      
      const mouse = { x: -9999, y: -9999, inside: false, vx: 0, vy: 0, px: -9999, py: -9999 };
      window.addEventListener('mousemove', e => {
        mouse.inside = true;
        mouse.vx = e.clientX - mouse.px;
        mouse.vy = e.clientY - mouse.py;
        mouse.px = mouse.x = e.clientX;
        mouse.py = mouse.y = e.clientY;
      }, { passive: true });
      
      window.addEventListener('mouseleave', () => {
        mouse.inside = false;
        mouse.x = mouse.y = -9999;
        mouse.vx = mouse.vy = 0;
      }, { passive: true });
      
      const rand = (a, b) => Math.random() * (b - a) + a;
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      
      function resize() {
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        w = window.innerWidth;
        h = window.innerHeight;
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        homes = makeHomes(COUNT);
        if (particles.length) {
          for (let i = 0; i < particles.length; i++) {
            particles[i].hx = homes[i].x;
            particles[i].hy = homes[i].y;
          }
        }
      }
      
      window.addEventListener('resize', resize, { passive: true });
      
      function makeHomes(n) {
        const homes = [];
        const aspect = w / Math.max(1, h);
        const cols = Math.max(12, Math.floor(Math.sqrt(n * aspect)));
        const rows = Math.ceil(n / cols);
        const cw = w / cols, ch = h / rows;
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            const x = (c + 0.5) * cw + rand(-cw * 0.38, cw * 0.38);
            const y = (r + 0.5) * ch + rand(-ch * 0.38, ch * 0.38);
            homes.push({ x: clamp(x, 0, w), y: clamp(y, 0, h) });
          }
        }
        for (let i = homes.length - 1; i > 0; i--) {
          const j = (Math.random() * (i + 1)) | 0;
          [homes[i], homes[j]] = [homes[j], homes[i]];
        }
        return homes.slice(0, n);
      }
      
      const COLORS = [[0,212,255], [124,77,255], [80,190,255], [170,120,255], [255,255,255]];
      const pickColor = () => COLORS[(Math.random() * COLORS.length) | 0];
      
      let homes = [];
      const particles = [];
      
      function init() {
        resize();
        particles.length = 0;
        for (let i = 0; i < COUNT; i++) {
          const c = pickColor();
          const z = rand(0.20, 1.0);
          const dir = Math.random() < 0.5 ? -1 : 1;
          particles.push({
            x: homes[i].x, y: homes[i].y,
            hx: homes[i].x, hy: homes[i].y,
            vx: rand(-0.25, 0.25), vy: rand(-0.25, 0.25),
            len: rand(LINE_MIN, LINE_MAX) * (0.65 + z * 0.85),
            lw: rand(0.9, 1.7) * (0.55 + z * 0.65),
            a: rand(0.18, 0.55) * (0.55 + z * 0.55),
            z, dir, cr: c[0], cg: c[1], cb: c[2],
            seed: rand(0, 9999)
          });
        }
      }
      init();
      
      const R = isMobile ? 240 : 340, R2 = R * R;
      const PULL = isMobile ? 0.070 : 0.085;
      const SWIRL = isMobile ? 0.110 : 0.140;
      const ORBIT = isMobile ? 0.018 : 0.022;
      const MOUSE_BOOST = isMobile ? 0.0012 : 0.0016;
      const RETURN_K = isMobile ? 0.030 : 0.034;
      const RETURN_DAMP = isMobile ? 0.86 : 0.84;
      const FOLLOW_DAMP = 0.92;
      const NOISE = isMobile ? 0.010 : 0.012;
      const MAXV = isMobile ? 4.0 : 5.2;
      
      function limit(p) {
        const sp = Math.hypot(p.vx, p.vy);
        if (sp > MAXV) {
          p.vx = (p.vx / sp) * MAXV;
          p.vy = (p.vy / sp) * MAXV;
        }
      }
      
      function field(p, t) {
        const nx = p.x / w, ny = p.y / h;
        const a = Math.sin((nx * 2.1 + ny * 1.7) * Math.PI + t * 0.00035 + p.seed)
          + Math.cos((ny * 2.4 - nx * 1.8) * Math.PI + t * 0.00028 - p.seed * 0.6);
        p.vx += Math.cos(a * 0.95) * (0.02 + p.z * 0.03);
        p.vy += Math.sin(a * 0.95) * (0.02 + p.z * 0.03);
      }
      
      function drawStreak(p) {
        const sp = Math.hypot(p.vx, p.vy);
        let ux = 1, uy = 0;
        if (sp > 0.001) {
          ux = p.vx / sp; uy = p.vy / sp;
        } else {
          ux = Math.cos(p.seed); uy = Math.sin(p.seed);
        }
        const tail = p.len * (0.65 + Math.min(1.2, sp / 2.2));
        const x1 = p.x, y1 = p.y;
        const x0 = x1 - ux * tail, y0 = y1 - uy * tail;
        const g = ctx.createLinearGradient(x0, y0, x1, y1);
        g.addColorStop(0, `rgba(${p.cr},${p.cg},${p.cb},0)`);
        g.addColorStop(0.55, `rgba(${p.cr},${p.cg},${p.cb},${p.a * 0.45})`);
        g.addColorStop(1, `rgba(${p.cr},${p.cg},${p.cb},${p.a})`);
        ctx.strokeStyle = g;
        ctx.lineWidth = p.lw;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x1, y1);
        ctx.stroke();
      }
      
      function tick(t) {
        ctx.clearRect(0, 0, w, h);
        ctx.globalCompositeOperation = 'lighter';
        for (const p of particles) {
          field(p, t);
          p.vx += rand(-NOISE, NOISE) * (0.35 + p.z);
          p.vy += rand(-NOISE, NOISE) * (0.35 + p.z);
          if (mouse.inside) {
            const dx = mouse.x - p.x, dy = mouse.y - p.y, d2 = dx * dx + dy * dy;
            if (d2 < R2) {
              const d = Math.sqrt(d2) || 1, k = 1 - d / R, kk = k * k;
              p.vx += (dx / d) * PULL * kk * (0.70 + p.z);
              p.vy += (dy / d) * PULL * kk * (0.70 + p.z);
              const tx = -dy / d, ty = dx / d;
              p.vx += tx * SWIRL * kk * p.dir * (0.65 + p.z);
              p.vy += ty * SWIRL * kk * p.dir * (0.65 + p.z);
              p.vx += tx * ORBIT * k * p.dir;
              p.vy += ty * ORBIT * k * p.dir;
              p.vx += mouse.vx * MOUSE_BOOST * kk * (0.6 + p.z);
              p.vy += mouse.vy * MOUSE_BOOST * kk * (0.6 + p.z);
              p.vx *= FOLLOW_DAMP;
              p.vy *= FOLLOW_DAMP;
            } else {
              p.vx += (p.hx - p.x) * RETURN_K * 0.30;
              p.vy += (p.hy - p.y) * RETURN_K * 0.30;
              p.vx *= 0.965; p.vy *= 0.965;
            }
          } else {
            p.vx += (p.hx - p.x) * RETURN_K;
            p.vy += (p.hy - p.y) * RETURN_K;
            p.vx *= RETURN_DAMP; p.vy *= RETURN_DAMP;
          }
          limit(p);
          p.x += p.vx; p.y += p.vy;
          if (p.x < 0) { p.x = 0; p.vx *= -0.55; }
          if (p.x > w) { p.x = w; p.vx *= -0.55; }
          if (p.y < 0) { p.y = 0; p.vy *= -0.55; }
          if (p.y > h) { p.y = h; p.vy *= -0.55; }
          drawStreak(p);
        }
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    })();
  </script>
</body>
</html>