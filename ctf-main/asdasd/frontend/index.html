<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SDHGCTF | é¢˜ç›®å¤§å…</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --bg0:#050b1a;
      --bg1:#081a2f;
      --glass: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.18);
      --accent:#00d4ff;
      --accent2:#7c4dff;
      --good:#2ee59d;
      --warn:#ffb020;
      --danger:#ff4d6d;
      --text:#e9f2ff;
      --muted: rgba(233,242,255,.65);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    body{
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 15% 20%, rgba(0,212,255,.18), transparent 60%),
        radial-gradient(700px 500px at 85% 30%, rgba(124,77,255,.18), transparent 60%),
        radial-gradient(800px 600px at 40% 90%, rgba(255,77,109,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      overflow-x:hidden;
    }

    .noise:before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      opacity:.09; pointer-events:none;
      mix-blend-mode: overlay;
      z-index: 2;
    }

    .aurora-layer{
      position: fixed;
      inset: -22vh -22vw;
      pointer-events: none;
      z-index: 1;
      opacity: .55;
      filter: blur(46px) saturate(160%);
      mix-blend-mode: screen;
      background:
        radial-gradient(60% 50% at 20% 30%, rgba(0,212,255,.32), transparent 60%),
        radial-gradient(55% 45% at 78% 28%, rgba(124,77,255,.30), transparent 62%),
        radial-gradient(50% 40% at 35% 78%, rgba(0,212,255,.22), transparent 62%),
        radial-gradient(48% 40% at 85% 80%, rgba(124,77,255,.20), transparent 62%);
      animation: auroraFloat 14s ease-in-out infinite alternate;
      transform: translate3d(0,0,0);
      will-change: transform;
    }
    .aurora-layer.layer2{
      opacity: .42;
      filter: blur(62px) saturate(170%);
      animation-duration: 18s;
      background:
        radial-gradient(52% 45% at 30% 25%, rgba(124,77,255,.24), transparent 62%),
        radial-gradient(58% 48% at 70% 40%, rgba(0,212,255,.20), transparent 62%),
        radial-gradient(55% 45% at 45% 85%, rgba(124,77,255,.18), transparent 62%);
    }
    @keyframes auroraFloat{
      0%   { transform: translate3d(-3%, -2%, 0) scale(1.02) rotate(-1deg); }
      50%  { transform: translate3d( 2%,  3%, 0) scale(1.05) rotate( 1deg); }
      100% { transform: translate3d(-1%,  2%, 0) scale(1.03) rotate(-0.6deg); }
    }

    #fx-canvas{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
    }

    #app{ position: relative; }

    .modal-backdrop{ z-index: 1050; }
    .modal{ z-index: 1055; }
    .glass{
      background: var(--glass);
      border:1px solid var(--stroke);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: var(--shadow);
      border-radius: 18px;
    }
    .topbar{
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 12px 0;
      background: rgba(5,11,26,.55);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .brand{ display:flex; align-items:center; gap:10px; user-select:none; }
    .brand .logo{
      width:42px; height:42px; border-radius:14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(0,212,255,.35), rgba(124,77,255,.35));
      border:1px solid var(--stroke);
    }
    .brand .title{ font-weight: 800; letter-spacing:.5px; margin:0; line-height:1.15; }
    .brand small{ color:var(--muted); }

    .btn-soft{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
    }
    .btn-soft:hover{ filter:brightness(1.06); color:var(--text); }

    .stat{
      padding: 14px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
    }
    .stat .k{ color:var(--muted); font-size:.9rem; }
    .stat .v{
      font-size:1.5rem;
      font-weight:800;
      color: var(--accent);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    .progress-wrap{
      height:10px;
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .progress-barx{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(0,212,255,.95), rgba(124,77,255,.95));
      border-radius: 999px;
      transition: width .35s ease;
    }

    .cat-pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:.55rem .9rem;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color: var(--muted);
      cursor: pointer;
      user-select:none;
    }
    .cat-pill.active{
      color: var(--text);
      border-color: rgba(0,212,255,.45);
      background: rgba(0,212,255,.10);
      box-shadow: 0 0 0 .25rem rgba(0,212,255,.10);
    }

    .challenge-card{
      padding: 16px 16px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      height: 100%;
    }
    .challenge-card:hover{
      transform: translateY(-3px);
      border-color: rgba(0,212,255,.35);
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
    }

    .badge-soft{
      background: rgba(0,212,255,.10);
      border:1px solid rgba(0,212,255,.25);
      color: var(--accent);
      font-weight:700;
    }
    .badge-solved{
      background: rgba(46,229,157,.10);
      border:1px solid rgba(46,229,157,.25);
      color: var(--good);
      font-weight:700;
    }

    .side-title{ font-weight: 800; letter-spacing:.3px; margin-bottom: 10px; }

    .list-item{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      margin-bottom: 10px;
    }
    .muted{ color: var(--muted); }

    .modal-content{
      background: rgba(5,11,26,.85);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(18px);
      color: var(--text);
    }

    .form-control{
      background: rgba(5,11,26,.65);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
    }
    .form-control:focus{
      background: rgba(5,11,26,.8);
      border-color: rgba(0,212,255,.55);
      box-shadow: 0 0 0 .25rem rgba(0,212,255,.12);
      color: var(--text);
    }

    @media (prefers-reduced-motion: reduce){
      .aurora-layer{ animation: none; }
      #fx-canvas{ display:none; }
    }
  </style>
</head>

<body class="noise">
  <canvas id="fx-canvas"></canvas>
  <div class="aurora-layer"></div>
  <div class="aurora-layer layer2"></div>

  <div id="app">
    <div class="topbar">
      <div class="container-fluid px-3 px-lg-4">
        <div class="d-flex justify-content-between align-items-center">
          <div class="brand">
            <div class="logo"><i class="fa-solid fa-shield-halved"></i></div>
            <div>
              <div class="title">å±±ä¸œåŒ–å·¥ç½‘ç»œå®‰å…¨ CTF</div>
              <small>é¢˜ç›®å¤§å… Â· å®æ—¶åŠ¨æ€</small>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="btn btn-soft btn-sm">
              <i class="fa-solid fa-user-ninja me-2"></i><span id="nav-username">--</span>
            </span>
            <a class="btn btn-soft btn-sm" href="matrix.html"><i class="fa-solid fa-th me-2"></i>è§£é¢˜ä½å›¾</a>
            <a class="btn btn-soft btn-sm" href="scoreboard.html"><i class="fa-solid fa-trophy me-2"></i>è£èª‰æ¦œ</a>
            <a id="btn-admin" class="btn btn-soft btn-sm d-none" href="admin.html"><i class="fa-solid fa-user-gear me-2"></i>ç®¡ç†å‘˜</a>
            <button class="btn btn-soft btn-sm" onclick="logout()"><i class="fa-solid fa-right-from-bracket me-2"></i>é€€å‡º</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid px-3 px-lg-4 py-4">
      <div class="row g-4">
        <div class="col-lg-9">
          <div class="glass p-3">
            <div class="row g-3 align-items-center">
              <div class="col-md-4">
                <div class="stat">
                  <div class="k"><i class="fa-solid fa-coins me-2"></i>æˆ‘çš„å½“å‰ç§¯åˆ†</div>
                  <div class="v" id="ui-score">0</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat">
                  <div class="k"><i class="fa-solid fa-ranking-star me-2"></i>å®æ—¶æ’å</div>
                  <div class="v" id="ui-rank">--</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat">
                  <div class="k"><i class="fa-solid fa-chart-line me-2"></i>è§£é¢˜ä»»åŠ¡è¿›åº¦</div>
                  <div class="mt-2 progress-wrap">
                    <div class="progress-barx" id="ui-progressbar"></div>
                  </div>
                  <div class="mt-2 muted"><span id="ui-progress">0</span>%</div>
                </div>
              </div>
            </div>
          </div>

          <div class="glass p-3 mt-4">
            <div class="d-flex flex-wrap gap-2">
              <div class="cat-pill active" data-cat="0" onclick="setCategory(0)"><i class="fa-solid fa-layer-group"></i>å…¨éƒ¨é¢˜ç›®</div>
              <div class="cat-pill" data-cat="1" onclick="setCategory(1)"><i class="fa-solid fa-puzzle-piece"></i>MISC</div>
              <div class="cat-pill" data-cat="2" onclick="setCategory(2)"><i class="fa-solid fa-wave-square"></i>æµé‡åˆ†æ</div>
              <div class="cat-pill" data-cat="3" onclick="setCategory(3)"><i class="fa-solid fa-globe"></i>Web</div>
              <div class="cat-pill" data-cat="4" onclick="setCategory(4)"><i class="fa-solid fa-terminal"></i>REVERSE</div>
            </div>
          </div>

          <div class="mt-4" id="challenges-container">
            <div class="glass p-4 text-center muted">
              <i class="fa-solid fa-spinner fa-spin me-2"></i>æ­£åœ¨åŠ è½½é¢˜ç›®...
            </div>
          </div>
        </div>

        <div class="col-lg-3">
          <div class="glass p-3">
            <div class="side-title"><i class="fa-solid fa-bolt me-2"></i>å®æ—¶åŠ¨æ€</div>
            <div id="activity-list" class="mt-2">
              <div class="muted">åŠ è½½ä¸­...</div>
            </div>
          </div>

          <div class="glass p-3 mt-4">
            <div class="side-title"><i class="fa-solid fa-crown me-2"></i>Top 5 æ¦œå•</div>
            <div id="leaderboard-list" class="mt-2">
              <div class="muted">åŠ è½½ä¸­...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="challengeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <div>
              <h5 class="modal-title mb-1" id="m-title">é¢˜ç›®</h5>
              <div class="muted small">
                <span class="badge badge-soft me-2" id="m-points">0 pts</span>
                <span class="badge badge-soft" id="m-cat">-</span>
                <span class="badge badge-solved ms-2 d-none" id="m-solved"><i class="fa-solid fa-check me-1"></i>å·²å®Œæˆ</span>
              </div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body pt-0">
            <div class="glass p-3 mb-3" style="background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.10);">
              <div class="muted small mb-2"><i class="fa-solid fa-file-lines me-2"></i>é¢˜ç›®æè¿°</div>
              <div id="m-desc" style="white-space:pre-wrap;"></div>
            </div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <a id="m-download" class="btn btn-soft btn-sm d-none" target="_blank">
                <i class="fa-solid fa-download me-2"></i>ä¸‹è½½é™„ä»¶
              </a>
              <span class="btn btn-soft btn-sm">
                <i class="fa-solid fa-people-group me-2"></i>Top Solvers:
                <span id="m-solvers" class="ms-1 muted">--</span>
              </span>
            </div>
            <div class="glass p-3" style="background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.10);">
              <div class="muted small mb-2"><i class="fa-solid fa-flag-checkered me-2"></i>æäº¤ Flag</div>
              <div class="input-group">
                <input id="m-flag" class="form-control" placeholder="flag{...}">
                <button id="m-submit" class="btn btn-soft" onclick="submitFlag()"><i class="fa-solid fa-paper-plane me-2"></i>æäº¤</button>
              </div>
              <div class="muted small mt-2">æç¤ºï¼šFlag åŒºåˆ†å¤§å°å†™ï¼Œè¯·å®Œæ•´ç²˜è´´ã€‚</div>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button class="btn btn-soft" data-bs-dismiss="modal">å…³é—­</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_PORT = 5000;
    const API_HOST = (location.port === String(API_PORT))
      ? `${location.protocol}//${location.host}`
      : `${location.protocol}//${location.hostname}:${API_PORT}`;
    const API_BASE = `${API_HOST}/api`;

    function getToken(){ return localStorage.getItem('ctf_token') || ''; }

    async function apiFetch(url, options = {}){
      const target = url.startsWith('http') ? url : `${API_BASE}${url}`;
      const method = (options.method || 'GET').toUpperCase();
      const headers = Object.assign({}, (options.headers || {}));
      if(!headers['Content-Type'] && method !== 'GET' && method !== 'HEAD'){
        headers['Content-Type'] = 'application/json';
      }
      const token = getToken();
      if(token) headers['Authorization'] = `Bearer ${token}`;
      return fetch(target, Object.assign({}, options, { headers, cache:'no-store' }));
    }

    const categories = { 1:'MISC', 2:'æµé‡åˆ†æ', 3:'Web', 4:'REVERSE' };
    let currentCat = 0;
    let allChallenges = [];
    let currentChallenge = null;

    function unwrap(json){ return (json && json.data !== undefined) ? json.data : json; }

    function checkAuth(){
      const token = localStorage.getItem('ctf_token');
      const username = localStorage.getItem('username');
      if(!token || !username){
        window.location.href = 'login.html';
        return false;
      }
      document.getElementById('nav-username').textContent = username;
      const isAdmin = localStorage.getItem('is_admin') === '1';
      if(isAdmin) document.getElementById('btn-admin').classList.remove('d-none');
      return true;
    }

    async function authFetch(url, options={}){
      const resp = await apiFetch(url, options);
      if(resp.status === 401 || resp.status === 422){
        localStorage.clear();
        await Swal.fire({ icon:'warning', title:'ç™»å½•å·²è¿‡æœŸ', text:'è¯·é‡æ–°ç™»å½•', background:'#0a162e', color:'#fff' });
        window.location.href = 'login.html';
        throw new Error('Auth expired');
      }
      return resp;
    }

    function setCategory(cat){
      currentCat = cat;
      document.querySelectorAll('.cat-pill').forEach(p=>{
        p.classList.toggle('active', p.getAttribute('data-cat') == String(cat));
      });
      renderChallenges();
    }

    function escapeHtml(str){
      return String(str||'')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // âœ… å…¼å®¹åç«¯å­—æ®µåï¼šä»å¤šä¸ª key é‡Œå–ç¬¬ä¸€ä¸ªæœ‰å€¼çš„
    function pick(obj, keys, def='-'){
      for(const k of keys){
        if(obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== ''){
          return obj[k];
        }
      }
      return def;
    }

    // âœ… æ—¶é—´æ ¼å¼å…¼å®¹ï¼šæ”¯æŒ ç§’/æ¯«ç§’æ—¶é—´æˆ³ã€ISOã€"YYYY-MM-DD HH:mm:ss"
    function formatTime(val){
      if(val === null || val === undefined) return '-';

      const s0 = String(val).trim();
      if(/^\d+$/.test(s0)){
        const n = Number(s0);
        const ms = (n < 1e12) ? n * 1000 : n;
        const d = new Date(ms);
        if(!isNaN(d.getTime())){
          return d.toLocaleString('zh-CN', { hour12:false });
        }
      }

      if(/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(:\d{2})?$/.test(s0)){
        return s0;
      }

      const d = new Date(s0);
      if(!isNaN(d.getTime())){
        return d.toLocaleString('zh-CN', { hour12:false });
      }

      return s0 || '-';
    }

    // âœ… å…¼å®¹ Top solversï¼šæ”¯æŒ ["a","b"] / [{username:"a"}] / æ··åˆ
    function normalizeSolvers(raw){
      if(!Array.isArray(raw)) return [];
      return raw.map(s=>{
        if(typeof s === 'string') return s;
        if(s && typeof s === 'object'){
          return s.username ?? s.user ?? s.name ?? s.nickname ?? '';
        }
        return '';
      }).filter(Boolean);
    }

    function renderChallenges(){
      const container = document.getElementById('challenges-container');
      if(!Array.isArray(allChallenges) || allChallenges.length === 0){
        container.innerHTML = `<div class="glass p-4 text-center muted">æš‚æ— é¢˜ç›®æ•°æ®</div>`;
        return;
      }
      let html = '';
      Object.entries(categories).forEach(([id, name])=>{
        if(currentCat !== 0 && String(currentCat) !== String(id)) return;

        const list = allChallenges.filter(c => (c.category === name) || (String(c.category_id) === String(id)));
        if(list.length === 0) return;

        html += `
          <div class="mb-3 mt-2">
            <div class="muted small text-uppercase" style="letter-spacing:2px">${name}</div>
          </div>
          <div class="row g-3 mb-4">
        `;

        list.forEach(ch=>{
          const rawSolvers = ch.solvers ?? ch.top_solvers ?? ch.topSolvers ?? ch.top_solver ?? [];
          const solvers = normalizeSolvers(rawSolvers);

          const solverText = solvers.length
            ? solvers.map(s=>`<span class="badge badge-soft me-1">${escapeHtml(s)}</span>`).join('')
            : `<span class="muted">æš‚æ— </span>`;

          const solvedBadge = ch.solved
            ? `<span class="badge badge-solved ms-2"><i class="fa-solid fa-check me-1"></i>å·²å®Œæˆ</span>`
            : '';

          html += `
            <div class="col-md-6 col-xl-4">
              <div class="challenge-card" onclick="openModal(${ch.id})">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="fw-bold fs-5">${escapeHtml(ch.title)}</div>
                  <span class="badge badge-soft">${ch.points} pts</span>
                </div>
                <div class="mt-2 small muted">
                  <i class="fa-solid fa-users me-2"></i>${solverText}
                  ${solvedBadge}
                </div>
              </div>
            </div>
          `;
        });

        html += `</div>`;
      });

      container.innerHTML = html || `<div class="glass p-4 text-center muted">è¯¥åˆ†ç±»æš‚æ— é¢˜ç›®</div>`;
    }

    async function loadChallenges(){
      const resp = await authFetch('/challenges');
      const json = await resp.json().catch(()=> ({}));
      if(!resp.ok) throw new Error(json.error || json.message || 'åŠ è½½é¢˜ç›®å¤±è´¥');
      allChallenges = unwrap(json);
      renderChallenges();
    }

    async function loadUserStatus(){
      const resp = await authFetch('/user_status');
      const json = await resp.json().catch(()=> ({}));
      const data = unwrap(json);
      document.getElementById('ui-score').textContent = data.score ?? 0;
      document.getElementById('ui-rank').textContent = data.rank ?? '--';
      const p = data.progress ?? 0;
      document.getElementById('ui-progress').textContent = p;
      document.getElementById('ui-progressbar').style.width = `${p}%`;
    }

    // âœ… ä¿®å¤ï¼šå®æ—¶åŠ¨æ€é¢˜ç›®å & æ—¶é—´å­—æ®µå…¼å®¹
    async function loadActivity(){
      const box = document.getElementById('activity-list');
      try{
        const resp = await apiFetch('/activity', { cache:'no-store' });
        const json = await resp.json().catch(()=> ({}));
        const data = unwrap(json);

        if(!Array.isArray(data) || data.length === 0){
          box.innerHTML = `<div class="muted">æš‚æ— åŠ¨æ€</div>`;
          return;
        }

        box.innerHTML = data.map(x=>{
          const username = pick(x, ['username','user','name'], '--');
          const title = pick(x, [
            'title','challenge','challenge_title','challenge_name','chal_title','chal','problem','problem_title'
          ], '-');

          const tRaw = pick(x, ['time','solved_at','created_at','timestamp','ts','datetime'], '-');
          const t = formatTime(tRaw);

          return `
            <div class="list-item">
              <div class="small"><i class="fa-solid fa-user-ninja me-2"></i><b>${escapeHtml(username)}</b></div>
              <div class="small muted"><i class="fa-solid fa-flag me-2"></i>è§£å‡ºï¼š${escapeHtml(title)}</div>
              <div class="small muted"><i class="fa-regular fa-clock me-2"></i>${escapeHtml(t)}</div>
            </div>
          `;
        }).join('');
      }catch(e){
        console.error(e);
        box.innerHTML = `<div class="muted">æš‚æ— åŠ¨æ€</div>`;
      }
    }

    async function loadLeaderboardTop5(){
      const resp = await apiFetch('/scoreboard');
      const json = await resp.json().catch(()=> ({}));
      const data = unwrap(json);
      const box = document.getElementById('leaderboard-list');
      if(!Array.isArray(data) || data.length === 0){
        box.innerHTML = `<div class="muted">æš‚æ— æ•°æ®</div>`;
        return;
      }
      const top = data.slice(0,5);
      box.innerHTML = top.map((u,idx)=>`
        <div class="list-item d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-bold">${idx+1}. ${escapeHtml(u.username)}</div>
            <div class="small muted">è§£é¢˜ ${u.solved || 0}</div>
          </div>
          <div class="fw-bold" style="color:var(--accent)">${u.score || 0}</div>
        </div>
      `).join('');
    }

    function cleanupBackdrops(){
      document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('padding-right');
    }

    function openModal(cid){
      const ch = allChallenges.find(x=>x.id === cid);
      if(!ch) return;
      currentChallenge = ch;

      document.getElementById('m-title').textContent = ch.title;
      document.getElementById('m-desc').textContent = ch.description || '';
      document.getElementById('m-points').textContent = `${ch.points} pts`;
      document.getElementById('m-cat').textContent = ch.category || '-';

      // âœ… ä¿®å¤ï¼šTop Solvers å­—æ®µå…¼å®¹
      const rawSolvers = ch.solvers ?? ch.top_solvers ?? ch.topSolvers ?? ch.top_solver ?? [];
      const solvers = normalizeSolvers(rawSolvers);
      document.getElementById('m-solvers').textContent = solvers.length ? solvers.join(' / ') : 'æš‚æ— ';

      const solved = !!ch.solved;
      document.getElementById('m-solved').classList.toggle('d-none', !solved);
      document.getElementById('m-submit').disabled = solved;

      const download = document.getElementById('m-download');
      if(ch.file_url){
        let url = ch.file_url;
        if(url.startsWith('/download/') || url.startsWith('/static/')) url = `${API_HOST}${url}`;
        if(url.includes('/download/')){
          const tk = getToken();
          if(tk){
            url += (url.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(tk);
          }
        }
        download.href = url;
        download.classList.remove('d-none');
      }else{
        download.classList.add('d-none');
      }

      document.getElementById('m-flag').value = '';

      const el = document.getElementById('challengeModal');
      const modal = bootstrap.Modal.getOrCreateInstance(el);
      modal.show();
    }

    async function submitFlag(){
      if(!currentChallenge) return;
      const flag = document.getElementById('m-flag').value.trim();
      if(!flag) return Swal.fire({icon:'warning', title:'è¯·è¾“å…¥ Flag', background:'#0a162e', color:'#fff'});

      const btn = document.getElementById('m-submit');
      btn.disabled = true;

      try{
        const resp = await authFetch('/submit', {
          method:'POST',
          body: JSON.stringify({challenge_id: currentChallenge.id, flag})
        });
        const json = await resp.json().catch(()=> ({}));

        if(resp.ok && json.correct){
          await Swal.fire({icon:'success', title:'ğŸ‰ æ­å–œï¼', text: json.message || 'Flag æ­£ç¡®ï¼', background:'#0a162e', color:'#fff'});
          bootstrap.Modal.getInstance(document.getElementById('challengeModal'))?.hide();
          await safeRun(loadChallenges);
          await safeRun(loadUserStatus);
          await safeRun(loadLeaderboardTop5);
          await safeRun(loadActivity);
        }else{
          await Swal.fire({icon:'error', title:'æäº¤å¤±è´¥', text: (json.message || json.error || 'Flag é”™è¯¯'), background:'#0a162e', color:'#fff'});
          btn.disabled = false;
        }
      }catch(e){
        btn.disabled = false;
      }
    }

    async function logout(){
      try{ await apiFetch('/logout', {method:'POST'}); }catch(e){}
      localStorage.clear();
      window.location.href = 'login.html';
    }

    async function safeRun(fn){
      try{ await fn(); }catch(e){ console.error(e); }
    }

    async function boot(){
      if(!checkAuth()) return;

      const modalEl = document.getElementById('challengeModal');
      modalEl.addEventListener('hidden.bs.modal', cleanupBackdrops);
      modalEl.addEventListener('show.bs.modal', cleanupBackdrops);

      try{
        await loadUserStatus();
        await loadChallenges();
        await loadLeaderboardTop5();
        await loadActivity();
      }catch(e){
        console.error(e);
        Swal.fire({icon:'error', title:'åŠ è½½å¤±è´¥', text: String(e.message || e), background:'#0a162e', color:'#fff'});
      }

      setInterval(()=>safeRun(loadUserStatus), 10000);
      setInterval(()=>safeRun(loadActivity), 15000);
      setInterval(()=>safeRun(loadLeaderboardTop5), 15000);
      setInterval(()=>safeRun(loadChallenges), 20000);
    }
    window.addEventListener('DOMContentLoaded', boot);

    // ======================= ç²’å­åŠ¨ç”»ï¼ˆåŸæ ·ä¿ç•™ï¼‰ =======================
    (function(){
      const canvas = document.getElementById('fx-canvas');
      if(!canvas) return;

      const prefersReduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(prefersReduce) return;

      const ctx = canvas.getContext('2d', { alpha:true });
      let w=0, h=0, dpr=1;

      const isMobile = matchMedia('(max-width: 768px)').matches;
      const COUNT = isMobile ? 220 : 520;
      const LINE_MIN = isMobile ? 6 : 7;
      const LINE_MAX = isMobile ? 14 : 18;

      const mouse = { x:-9999, y:-9999, inside:false, vx:0, vy:0, px:-9999, py:-9999 };
      window.addEventListener('mousemove', (e)=>{
        mouse.inside = true;
        mouse.vx = e.clientX - mouse.px;
        mouse.vy = e.clientY - mouse.py;
        mouse.px = e.clientX;
        mouse.py = e.clientY;
        mouse.x = e.clientX;
        mouse.y = e.clientY;
      }, {passive:true});
      window.addEventListener('mouseleave', ()=>{
        mouse.inside = false;
        mouse.x = mouse.y = -9999;
        mouse.vx = mouse.vy = 0;
      }, {passive:true});

      const rand = (a,b)=> Math.random()*(b-a)+a;
      const clamp = (v,a,b)=> Math.max(a, Math.min(b,v));

      function makeHomes(n){
        const homes = [];
        const aspect = w / Math.max(1,h);
        const cols = Math.max(12, Math.floor(Math.sqrt(n*aspect)));
        const rows = Math.ceil(n/cols);
        const cw = w/cols, ch = h/rows;
        for(let r=0;r<rows;r++){
          for(let c=0;c<cols;c++){
            const x = (c+0.5)*cw + rand(-cw*0.38, cw*0.38);
            const y = (r+0.5)*ch + rand(-ch*0.38, ch*0.38);
            homes.push({ x: clamp(x, 0, w), y: clamp(y, 0, h) });
          }
        }
        for(let i=homes.length-1;i>0;i--){
          const j = (Math.random()*(i+1))|0;
          [homes[i], homes[j]] = [homes[j], homes[i]];
        }
        return homes.slice(0,n);
      }

      const COLORS = [
        [0,212,255],[124,77,255],[80,190,255],[170,120,255],[255,255,255]
      ];
      const pickColor = ()=> COLORS[(Math.random()*COLORS.length)|0];

      let homes = [];
      const particles = [];

      function resize(){
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        w = window.innerWidth;
        h = window.innerHeight;
        canvas.width = Math.floor(w*dpr);
        canvas.height = Math.floor(h*dpr);
        canvas.style.width = w+'px';
        canvas.style.height = h+'px';
        ctx.setTransform(dpr,0,0,dpr,0,0);
        homes = makeHomes(COUNT);
        if(particles.length){
          for(let i=0;i<particles.length;i++){
            particles[i].hx = homes[i].x;
            particles[i].hy = homes[i].y;
          }
        }
      }
      window.addEventListener('resize', resize, {passive:true});

      function init(){
        resize();
        particles.length = 0;
        for(let i=0;i<COUNT;i++){
          const c = pickColor();
          const z = rand(0.20, 1.0);
          const dir = Math.random() < 0.5 ? -1 : 1;
          particles.push({
            x: homes[i].x, y: homes[i].y, hx: homes[i].x, hy: homes[i].y,
            vx: rand(-0.25, 0.25), vy: rand(-0.25, 0.25),
            len: rand(LINE_MIN, LINE_MAX) * (0.65 + z*0.85),
            lw: rand(0.9, 1.7) * (0.55 + z*0.65),
            a: rand(0.18, 0.55) * (0.55 + z*0.55),
            z, dir, cr: c[0], cg: c[1], cb: c[2],
            seed: rand(0, 9999)
          });
        }
      }
      init();

      const R = isMobile ? 240 : 340;
      const R2 = R*R;
      const PULL = isMobile ? 0.070 : 0.085;
      const SWIRL = isMobile ? 0.110 : 0.140;
      const ORBIT = isMobile ? 0.018 : 0.022;
      const MOUSE_BOOST = isMobile ? 0.0012 : 0.0016;

      const RETURN_K = isMobile ? 0.030 : 0.034;
      const RETURN_DAMP = isMobile ? 0.86 : 0.84;
      const FOLLOW_DAMP = 0.92;
      const NOISE = isMobile ? 0.010 : 0.012;
      const MAXV = isMobile ? 4.0 : 5.2;

      function limit(p){
        const sp = Math.hypot(p.vx, p.vy);
        if(sp > MAXV){
          p.vx = (p.vx/sp)*MAXV;
          p.vy = (p.vy/sp)*MAXV;
        }
      }

      function field(p, t){
        const nx = p.x / w, ny = p.y / h;
        const a = Math.sin((nx*2.1 + ny*1.7)*Math.PI + t*0.00035 + p.seed)
                + Math.cos((ny*2.4 - nx*1.8)*Math.PI + t*0.00028 - p.seed*0.6);
        const ang = a * 0.95;
        p.vx += Math.cos(ang) * (0.02 + p.z*0.03);
        p.vy += Math.sin(ang) * (0.02 + p.z*0.03);
      }

      function drawStreak(p){
        const vx = p.vx, vy = p.vy;
        const sp = Math.hypot(vx, vy);

        let ux = 1, uy = 0;
        if(sp > 0.001){
          ux = vx / sp;
          uy = vy / sp;
        }else{
          const a = p.seed;
          ux = Math.cos(a); uy = Math.sin(a);
        }

        const tail = p.len * (0.65 + Math.min(1.2, sp/2.2));
        const x1 = p.x, y1 = p.y;
        const x0 = x1 - ux * tail, y0 = y1 - uy * tail;

        const g = ctx.createLinearGradient(x0,y0,x1,y1);
        g.addColorStop(0.0, `rgba(${p.cr},${p.cg},${p.cb},0)`);
        g.addColorStop(0.55, `rgba(${p.cr},${p.cg},${p.cb},${p.a*0.45})`);
        g.addColorStop(1.0, `rgba(${p.cr},${p.cg},${p.cb},${p.a})`);

        ctx.strokeStyle = g;
        ctx.lineWidth = p.lw;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(x0, y0);
        ctx.lineTo(x1, y1);
        ctx.stroke();
      }

      function tick(t){
        ctx.clearRect(0,0,w,h);
        ctx.globalCompositeOperation = 'lighter';

        for(const p of particles){
          field(p, t);
          p.vx += rand(-NOISE, NOISE) * (0.35 + p.z);
          p.vy += rand(-NOISE, NOISE) * (0.35 + p.z);

          if(mouse.inside){
            const dx = mouse.x - p.x;
            const dy = mouse.y - p.y;
            const d2 = dx*dx + dy*dy;

            if(d2 < R2){
              const d = Math.sqrt(d2) || 1;
              const k = 1 - d / R;
              const kk = k*k;

              p.vx += (dx/d) * (PULL * kk) * (0.70 + p.z);
              p.vy += (dy/d) * (PULL * kk) * (0.70 + p.z);

              const tx = -dy/d, ty = dx/d;
              p.vx += tx * (SWIRL * kk) * p.dir * (0.65 + p.z);
              p.vy += ty * (SWIRL * kk) * p.dir * (0.65 + p.z);

              p.vx += tx * (ORBIT * k) * p.dir;
              p.vy += ty * (ORBIT * k) * p.dir;

              p.vx += mouse.vx * (MOUSE_BOOST * kk) * (0.6 + p.z);
              p.vy += mouse.vy * (MOUSE_BOOST * kk) * (0.6 + p.z);

              p.vx *= FOLLOW_DAMP;
              p.vy *= FOLLOW_DAMP;
            }else{
              p.vx += (p.hx - p.x) * (RETURN_K*0.30);
              p.vy += (p.hy - p.y) * (RETURN_K*0.30);
              p.vx *= 0.965;
              p.vy *= 0.965;
            }
          }else{
            p.vx += (p.hx - p.x) * RETURN_K;
            p.vy += (p.hy - p.y) * RETURN_K;
            p.vx *= RETURN_DAMP;
            p.vy *= RETURN_DAMP;
          }

          limit(p);

          p.x += p.vx; p.y += p.vy;

          if(p.x < 0){ p.x = 0; p.vx *= -0.55; }
          if(p.x > w){ p.x = w; p.vx *= -0.55; }
          if(p.y < 0){ p.y = 0; p.vy *= -0.55; }
          if(p.y > h){ p.y = h; p.vy *= -0.55; }

          drawStreak(p);
        }

        requestAnimationFrame(tick);
      }

      requestAnimationFrame(tick);
    })();
  </script>
</body>
</html>
